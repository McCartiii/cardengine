generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

/// Maps to Supabase auth.users via trigger.
/// On signup, a row is auto-created here via handle_new_user().
model User {
  id          String   @id // matches auth.users.id (UUID)
  createdAt   DateTime @default(now())
  minorSafe   Boolean  @default(true)
  dateOfBirth DateTime? @map("date_of_birth")
  displayName String?  @map("display_name")
  avatarUrl   String?  @map("avatar_url")
  banned      Boolean  @default(false)

  collectionEvents CollectionEvent[]
  watchlist        WatchlistEntry[]
  notifications    Notification[]
  decks            Deck[]
  pushTokens       PushToken[]
}

model CardVariant {
  /// Stable engine variant id (UUID/opaque string)
  variantId       String  @id
  game            String
  cardId          String
  printingId      String
  name            String
  setId           String?
  collectorNumber String?

  // Extended fields (Phase 2)
  oracleText      String?  @map("oracle_text")
  typeLine        String?  @map("type_line")
  colors          Json?    // JSON array e.g. ["W","U"]
  colorIdentity   Json?    @map("color_identity") // JSON array
  cmc             Float?
  manaCost        String?  @map("mana_cost")
  rarity          String?
  imageUri        String?  @map("image_uri")

  updatedAt DateTime @updatedAt

  prices           PricePoint[]
  collectionEvents CollectionEvent[]
  deckCards        DeckCard[]

  @@index([game, name])
  @@index([game, setId, collectorNumber])
}

model CollectionEvent {
  id        String   @id
  userId    String
  at        DateTime
  type      String
  variantId String
  payload   Json

  user    User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  variant CardVariant @relation(fields: [variantId], references: [variantId])

  @@index([userId, at])
  @@index([variantId, at])
}

model PricePoint {
  id        String   @id @default(cuid())
  at        DateTime
  market    String
  kind      String
  currency  String
  amount    Float
  variantId String

  variant CardVariant @relation(fields: [variantId], references: [variantId])

  @@index([market, variantId, at])
}

model PriceCache {
  id        String   @id @default(cuid())
  market    String
  kind      String
  currency  String
  amount    Float
  variantId String
  updatedAt DateTime @updatedAt

  @@unique([market, variantId, kind, currency])
  @@index([variantId])
}

model WatchlistEntry {
  id              String   @id @default(cuid())
  userId          String
  variantId       String
  market          String
  kind            String
  currency        String
  thresholdAmount Float
  direction       String // "above" | "below"
  enabled         Boolean  @default(true)
  createdAt       DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, enabled])
}

model Notification {
  id        String   @id @default(cuid())
  userId    String
  type      String   // "price_alert" | "lfg_nearby" | etc.
  title     String
  body      String
  data      Json?
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read, createdAt])
}

// ── Decks ──

model Deck {
  id          String   @id @default(cuid())
  userId      String
  name        String
  format      String   @default("commander") // commander, standard, modern, pioneer, legacy, vintage, pauper, oathbreaker
  game        String   @default("mtg")
  commander   String?  // primary commander name (EDH/Oathbreaker)
  partner     String?  // partner commander name if applicable
  description String?
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  cards DeckCard[]

  @@index([userId, format])
  @@index([game, isPublic])
}

model DeckCard {
  id        String  @id @default(cuid())
  deckId    String
  variantId String? // null if card not yet in our DB
  cardName  String
  quantity  Int     @default(1)
  section   String  @default("mainboard") // mainboard | sideboard | commander | companion

  deck    Deck         @relation(fields: [deckId], references: [id], onDelete: Cascade)
  variant CardVariant? @relation(fields: [variantId], references: [variantId])

  @@index([deckId])
  @@index([variantId])
}

// ── Shop Directory ──

model Shop {
  id        String   @id @default(cuid())
  name      String
  address   String?
  city      String?
  state     String?
  zip       String?
  country   String   @default("US")
  lat       Float?
  lng       Float?
  phone     String?
  website   String?
  hours     String?
  category  String   @default("card_shop") // card_shop, hobby_shop, game_store, community_center
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([city, state])
  @@index([lat, lng])
}

// ── EDHREC Cache ──

model EdhrecCache {
  id        String   @id @default(cuid())
  key       String   @unique // sanitized commander name or theme key
  data      Json              // full EDHREC JSON response
  fetchedAt DateTime @default(now())

  @@index([key])
}

// ── Telemetry ──

model ScannerMismatch {
  id               String   @id @default(cuid())
  userId           String?
  ocrNameRaw       String
  ocrCnRaw         String?
  ocrSetRaw        String?
  ocrConfidence    Int
  candidateId      String? // variantId of top candidate
  confirmedId      String? // variantId user actually confirmed
  wasAutoConfirmed Boolean  @default(false)
  createdAt        DateTime @default(now())

  @@index([createdAt])
  @@index([ocrConfidence])
}

model RulesDisagreement {
  id            String   @id @default(cuid())
  userId        String?
  formatId      String
  game          String   @default("mtg")
  deckHash      String? // hash of card list for dedup
  violationCode String
  userDisputed  Boolean  @default(false)
  notes         String?
  createdAt     DateTime @default(now())

  @@index([formatId, createdAt])
  @@index([violationCode])
}

// ── Push notification tokens ──

model PushToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  platform  String   // "ios" | "android" | "web"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
